<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caméra Arrière Optimale</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #222;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
        }
        video {
            width: 90%;
            max-width: 600px;
            border: 2px solid white;
            border-radius: 8px;
        }
        .controls {
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 0 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>Caméra Arrière Optimale</h1>
    <video id="video" autoplay playsinline></video>
    <div class="controls">
        <button onclick="captureImage()">Capturer</button>
        <button onclick="stopCamera()">Arrêter</button>
    </div>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        let videoElement = document.getElementById('video');
        let canvasElement = document.getElementById('canvas');
        let currentStream;

        async function getBestBackCamera() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                // Filtrer pour exclure les caméras avec "zoom" ou "tele"
                let backCameras = videoDevices.filter(device => 
                    /back|arrière|environment/i.test(device.label) && 
                    !/zoom|tele/i.test(device.label)
                );

                // Si aucune caméra arrière claire n'a été trouvée, prendre la première caméra disponible
                if (backCameras.length === 0) {
                    backCameras = videoDevices;
                }

                // Retourner le premier appareil détecté comme caméra arrière principale
                return backCameras.length > 0 ? backCameras[0].deviceId : null;

            } catch (error) {
                console.error('Erreur lors de la détection des caméras:', error);
                return null;
            }
        }

        async function startCamera() {
            try {
                const bestCameraId = await getBestBackCamera();

                if (!bestCameraId) {
                    alert("Aucune caméra arrière détectée.");
                    return;
                }

                const constraints = {
                    video: {
                        deviceId: { exact: bestCameraId },
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = currentStream;

            } catch (error) {
                console.error("Erreur lors de l'accès à la caméra:", error);
                alert("Impossible d'accéder à la caméra. Vérifiez les permissions.");
            }
        }

        function captureImage() {
            if (!currentStream) return;

            const context = canvasElement.getContext('2d');
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            const imageData = canvasElement.toDataURL('image/png');
            console.log("Image capturée :", imageData);
            alert("Image capturée avec succès.");
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
        }

        startCamera();
    </script>

</body>
</html>
